// Nova Player Backend - Prisma Schema
// Base de données PostgreSQL externe (100% vanilla, sans Supabase)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ══════════════════════════════════════════════════════════════════════════
// ENUMS
// ══════════════════════════════════════════════════════════════════════════

enum DeviceStatus {
  trial
  active
  expired
  banned

  @@map("device_status")
}

enum DevicePlatform {
  android
  ios
  windows
  mac

  @@map("device_platform")
}

enum DeviceArchitecture {
  arm64
  x64

  @@map("device_architecture")
}

enum AdminRole {
  super_admin
  admin
  moderator

  @@map("admin_role")
}

enum ActorType {
  system
  admin
  user

  @@map("actor_type")
}

enum DeviceLogAction {
  device_registered
  trial_started
  trial_extended
  trial_expired
  status_check
  status_changed
  device_banned
  device_unbanned
  pin_regenerated
  device_activated
  manual_override_set

  @@map("device_log_action")
}

enum AdminLogAction {
  login
  logout
  device_view
  device_update
  device_activate
  device_ban
  device_unban
  trial_extend
  trial_reset
  pin_regenerate
  batch_action
  note_added
  settings_changed

  @@map("admin_log_action")
}

enum ActionType {
  register
  status_check
  activate
  ban
  unban
  extend_trial
  reset_trial
  set_expiry
  add_note
  batch_action
  regenerate_pin

  @@map("action_type")
}

// ══════════════════════════════════════════════════════════════════════════
// MODELS
// ══════════════════════════════════════════════════════════════════════════

model AdminUser {
  id            String    @id @default(uuid())
  email         String    @unique
  password_hash String
  name          String?
  role          AdminRole @default(admin)
  is_active     Boolean   @default(true)
  last_login    DateTime?
  updated_at    DateTime  @updatedAt
  created_at    DateTime  @default(now())

  // Relations
  admin_logs         AdminLog[]
  device_action_logs DeviceActionLog[]
  devices_created    Device[]          @relation("DeviceCreator")

  @@map("admin_users")
}

model Device {
  id             String             @id @default(uuid())
  device_id      String             @unique

  // UID + PIN System
  uid            String?            @unique
  pin_hash       String?
  pin_created_at DateTime?

  // Device Info
  platform       DevicePlatform
  os_version     String
  device_model   String
  architecture   DeviceArchitecture
  player_version String
  app_build      Int                @default(1)

  // Geolocation
  ip_address     String?
  country        String?
  city           String?
  isp            String?
  is_vpn         Boolean            @default(false)

  // Status & Trial
  status          DeviceStatus @default(trial)
  trial_start     DateTime?    @default(now())
  trial_end       DateTime?
  days_left       Int          @default(7)
  extended_count  Int          @default(0)
  manual_override Boolean      @default(false)

  // Timestamps
  first_seen DateTime @default(now())
  last_seen  DateTime @default(now())

  // Admin
  notes      String?
  created_by String?
  updated_at DateTime @updatedAt
  created_at DateTime @default(now())

  // Relations
  logs        DeviceLog[]
  action_logs DeviceActionLog[]
  creator     AdminUser?        @relation("DeviceCreator", fields: [created_by], references: [id], onDelete: SetNull)

  @@map("devices")
}

model DeviceLog {
  id              String           @id @default(uuid())
  device_id       String
  uid             String?
  action          DeviceLogAction
  previous_status DeviceStatus?
  new_status      DeviceStatus?
  actor_type      ActorType        @default(system)
  actor_id        String?
  reason          String?
  ip_address      String?
  metadata        Json?
  created_at      DateTime         @default(now())

  // Relations
  device Device @relation(fields: [device_id], references: [device_id], onDelete: Cascade)

  @@index([device_id])
  @@index([created_at])
  @@index([action])
  @@map("device_logs")
}

model AdminLog {
  id               String         @id @default(uuid())
  admin_id         String
  admin_email      String?
  action           AdminLogAction
  target_device_id String?
  target_uid       String?
  details          Json?
  ip_address       String?
  user_agent       String?
  created_at       DateTime       @default(now())

  // Relations
  admin AdminUser @relation(fields: [admin_id], references: [id], onDelete: Cascade)

  @@index([admin_id])
  @@index([created_at])
  @@index([action])
  @@map("admin_logs")
}

model DeviceActionLog {
  id         String     @id @default(uuid())
  device_id  String
  action     ActionType
  details    Json?
  admin_id   String?
  ip_address String?
  created_at DateTime   @default(now())

  // Relations
  device Device     @relation(fields: [device_id], references: [device_id], onDelete: Cascade)
  admin  AdminUser? @relation(fields: [admin_id], references: [id], onDelete: SetNull)

  @@index([device_id])
  @@index([action])
  @@index([created_at])
  @@map("device_action_logs")
}

model ApiLog {
  id               String   @id @default(uuid())
  endpoint         String
  method           String
  device_id        String?
  uid              String?
  ip_address       String?
  response_status  Int
  response_time_ms Int
  error_message    String?
  metadata         Json?
  created_at       DateTime @default(now())

  @@index([endpoint])
  @@index([created_at])
  @@index([device_id])
  @@index([response_status])
  @@map("api_logs")
}
